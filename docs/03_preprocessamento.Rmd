---
title: "03_preprocessamento.html"
output: html_document
date: "2025-04-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE, 
                      error = FALSE, 
                      warning = FALSE)
```

## üõ†Ô∏è Pr√©-processamento

Nesta etapa, vamos realizar um pr√©-processamento mais refinado dos dados, que inclui: visualiza√ß√£o espacial dos pontos para identificar padr√µes geogr√°ficos e poss√≠veis inconsist√™ncias de localiza√ß√£o; Filtragem de Linhas e Vari√°veis e Sele√ß√£o de observa√ß√µes e atributos relevantes para as pr√≥ximas etapas da an√°lise; Detec√ß√£o de Inconsist√™ncias: Identifica√ß√£o de valores extremos ou incoerentes que podem comprometer a qualidade das an√°lises futuras.

### üìÑ Carregando dados de emiss√µes

```{r}
emissions_sources <- readr::read_rds("../data/emissions_sources.rds")
```

### üîé Valida√ß√£o dos dados (ano = 2021)

Ap√≥s o tratamento, os dados foram analisados e comparados com as informa√ß√µes originais do site [Climate TRACE](https://climatetrace.org/), com o objetivo de verificar a consist√™ncia e a qualidade do processamento.

Ao buscar o munic√≠pio de **"Jaboticabal"** na plataforma, s√£o apresentadas v√°rias categorias de dados, referentes √†s emiss√µes de gases de efeito estufa em diferentes n√≠veis geogr√°ficos e fontes.

![](../img/ct_tutorial_05.jpg)

As principais categorias encontradas s√£o:

-   **City** - Jaboticabal Urban Area, BR: Refere-se √† √°rea urbana de Jaboticabal e apresenta dados de emiss√µes provenientes das atividades dentro dessa zona, como transporte, ind√∫stria e outros fatores urbanos.

![](../img/ct_tutorial_06.jpg)

```{r}
emissions_sources |>
    dplyr::filter(
    stringr::str_detect(source_name, "Jaboticabal") | muni == "Jaboticabal",
    year == 2024,
    !subsector %in% c("forest-land-clearing",
                     "forest-land-degradation",
                     "forest-land-fires",
                     "removals",
                     "shrubgrass-fires",
                     "wetland-fires"),
    # sector != "forestry-and-land-use"
    ) |>
 dplyr::group_by(sector) |>
  dplyr::summarise(
    emissions_quantity_sum = sum(emissions_quantity, na.rm = TRUE)
  ) |>
  dplyr::mutate(
   emissions_quantity_cumsum = cumsum(emissions_quantity_sum)
  )
```

-   **Country** - Jaboticabal Municipality, S√£o Paulo State, BRA: Relacionado ao munic√≠pio de Jaboticabal como um todo, esta categoria inclui dados sobre as emiss√µes em √°reas rurais e urbanas, englobando fontes como agricultura e uso do solo.

-   **Asset**: Refere-se a fontes espec√≠ficas de emiss√µes dentro da cidade ou munic√≠pio, como f√°bricas, usinas de energia ou instala√ß√µes industriais. Cada "asset" tem dados espec√≠ficos sobre suas emiss√µes, permitindo uma an√°lise mais detalhada.

### ‚è≥ Filtrando os dados para `forestry-and-land-use` e selecionando vari√°veis para a an√°lise.

```{r}
emissions_sources_forestry <- emissions_sources |> 
   dplyr::filter(
     gas == "co2e_100yr",
     sector == "forestry-and-land-use"
   ) |> 
   dplyr::mutate(
     source_name = stringr::str_to_title(source_name)
   ) |> 
  dplyr::select(
    -c(source_id,iso3_country,created_date,modified_date,lat_lon,directory,native_source_id,
       start_time,end_time,source_type,reporting_entity,sector_id,reporting_entity,geometry_ref)) |> 
  dplyr::relocate(year,month,lon,lat,source_name,muni,state,region)
```

### üìàüìä

Usa a fun√ß√£o `vis_miss()` do pacote `{visdat}` para visualizar graficamente os dados faltantes (NAs).

Ele gera um gr√°fico de calor onde:

```         
As c√©lulas preenchidas mostram dados presentes.

As c√©lulas em branco ou coloridas indicam dados ausentes.
```

```{r}
emissions_sources_forestry |> 
  dplyr::sample_n(3e4) |> 
  visdat::vis_miss()
```

### üó∫Ô∏è Plotando espacialmente os ponto

Nesta etapa, vamos representar os dados no espa√ßo geogr√°fico, gerando mapas que permitem visualizar a distribui√ß√£o dos pontos de interesse. A plotagem espacial √© fundamental para identificar padr√µes, √°reas de maior concentra√ß√£o e poss√≠veis anomalias nos dados.

Vamos carregar os pol√≠gonos de interesse

```{r}
country_br <- geobr::read_country(showProgress = FALSE)
conservation <- geobr::read_conservation_units(showProgress = FALSE)
indigenous <- geobr::read_indigenous_land(showProgress = FALSE)
```

Criando o mapa com sobreposi√ß√£o

Terras Ind√≠genas reconhecidas

```{r}
indigenous    |> 
  ggplot2::ggplot() +
  ggplot2::geom_sf(fill="white", color="black",
          size=.15, show.legend = FALSE) +
  ggplot2::geom_point(
    data = emissions_sources_forestry  |> 
      dplyr::filter(
        year == 2021,
        indigenous != "Other"),
     ggplot2::aes(lon,lat)) +
  ggplot2::theme_bw()
```

√Åreas de conserva√ß√£o

```{r}
conservation    |> 
  ggplot2::ggplot() +
  ggplot2::geom_sf(fill="white", color="black",
          size=.15, show.legend = FALSE) +
  ggplot2::geom_point(
    data = emissions_sources_forestry  |> 
      dplyr::filter(
        year == 2021,
        conservation != "Other"),
     ggplot2::aes(lon,lat)) +
  ggplot2::theme_bw()
```

### üìäüì¶ Visualiza√ß√£o dos Dados

Nesta se√ß√£o, ser√£o constru√≠dos histogramas e boxplots para avaliar a distribui√ß√£o das vari√°veis num√©ricas dispon√≠veis no conjunto de dados.

-   Histogramas ajudam a identificar o comportamento geral dos dados, como simetria, caudas longas ou concentra√ß√µes anormais de valores.

-   Boxplots facilitam a visualiza√ß√£o de outliers, assimetria e amplitude interquartil (IQR), sendo ferramentas r√°pidas para checagem da qualidade e integridade dos dados.

A combina√ß√£o dos dois gr√°ficos para cada vari√°vel permite uma an√°lise explorat√≥ria robusta e auxilia na identifica√ß√£o de poss√≠veis inconsist√™ncias ou necessidades de transforma√ß√£o dos dados para as etapas seguintes.

### üìäüì¶ Conhecendo o banco de dados com a fun√ß√£o `skim` do pacote `{skimr}`

```{r}
emissions_sources_forestry |> 
  skimr::skim()
```

### emissions_quantity

```{r}
x <- emissions_sources_forestry |> dplyr::pull(emissions_quantity)
x <- na.omit(x)
q1 <- quantile(x,.25)
q3 <- quantile(x,.75)
iiq <- q3-q1
emissions_sources_forestry |>
  dplyr::filter(emissions_quantity > q1-1.5*iiq, emissions_quantity<q3+1.5*iiq) |>
  tidyr::drop_na() |>
  ggplot2::ggplot(ggplot2::aes(x =emissions_quantity, y=..density.., fill=biomes_sig)) +
  ggplot2::geom_histogram(boundary=0, color="black",
                          bins = 100) +
  ggplot2::facet_wrap(~biomes_sig)+
  ggplot2::theme_bw()
```

### activity

```{r}
x <- emissions_sources_forestry |> dplyr::pull(activity)
x <- na.omit(x)
q1 <- quantile(x,.25)
q3 <- quantile(x,.75)
iiq <- q3-q1
emissions_sources_forestry |>
  # dplyr::select(activity,year) |>
  dplyr::filter(activity > q1-0.5*iiq, activity<q3*.01) |>
  tidyr::drop_na() |>
  ggplot2::ggplot(ggplot2::aes(x =activity, y=..density.., fill=biomes_sig)) +
  ggplot2::geom_histogram(boundary=0, color="black",
                          bins = 50) +
  ggplot2::facet_wrap(~biomes_sig)+
  ggplot2::theme_bw()
```

### emissions_factor

```{r}
x <- emissions_sources_forestry |> dplyr::pull(emissions_factor)
x <- na.omit(x)
q1 <- quantile(x,.25)
q3 <- quantile(x,.75)
iiq <- q3-q1
emissions_sources_forestry |>
  # dplyr::select(emissions_factor,year) |>
  dplyr::filter(emissions_factor > q1-0.5*iiq, emissions_factor<q3+0.5*iiq) |>
  tidyr::drop_na() |>
  ggplot2::ggplot(ggplot2::aes(x =emissions_factor, y = ..density.. ,fill=biomes_sig)) +
  ggplot2::geom_histogram(boundary=0, color="black",
                          bins = 50) +
  ggplot2::facet_wrap(~biomes_sig)+
  ggplot2::theme_bw()
```

### capacity

```{r}
x <- emissions_sources_forestry |> dplyr::pull(capacity)
x <- na.omit(x)
q1 <- quantile(x,.25)
q3 <- quantile(x,.75)
iiq <- q3-q1
emissions_sources_forestry |>
  dplyr::filter(capacity > q1-3.5*iiq, capacity<q3+3.5*iiq) |>
  tidyr::drop_na() |>
  ggplot2::ggplot(ggplot2::aes(x =capacity, y=..density.., fill=biomes_sig)) +
  ggplot2::geom_histogram(boundary=0, color="black",
                          bins = 100) +
  ggplot2::facet_wrap(~biomes_sig)+
  ggplot2::theme_bw()
```

### capacity_factor

```{r}
x <- emissions_sources_forestry |> dplyr::pull(capacity_factor)
x <- na.omit(x)
q1 <- quantile(x,.25)
q3 <- quantile(x,.75)
iiq <- q3-q1
emissions_sources_forestry |>
  dplyr::filter(capacity_factor > q1-0.5*iiq, capacity_factor<q3*.001) |>
  tidyr::drop_na() |>
  ggplot2::ggplot(ggplot2::aes(x =capacity_factor, y=..density..,fill=biomes_sig)) +
  ggplot2::geom_histogram(boundary=0, color="black",
                          bins = 50) +
  ggplot2::facet_wrap(~biomes_sig)+
  ggplot2::theme_bw()
```
